\subsection{Общие сведения о среде выполнения}
Автоматизированная система контроля исполнения и доведения документов (АСКИДД) является приложением реализующим концепцию <<тонкого клиента>>. В качестве протокола для обмена данными между сервером и клиентом используется протокол протокол передачи гипертекста HTTP (HyperText Transfer Protocol) 1.0 / 1.1 / 2.0. В качестве клиента используется веб-браузер (рекомендуется использование Google Chrome или Chromium, тем не менее допускается использование других браузеров). 

В базовой установке шифрование трафика не поддерживается, однако при наличии подключения к доверенным центрам выдачи сертификатов возможна организация шифорования трафика HTTPS (SSL (Secure Sockets Layer) / TLS (Transport Layer Security).

При разработке использовался подход MVC (Model View Controller), подразумевающий логическое разделение обработки поступающих запросов на сервер и отображение информации пользователю. 

На стороне клиента используется стек HTML (HyperText Markup Language ) / CSS (Cascading Style Sheets) / Javascript. Для поддержки различных дисплеев, а также  стилизации классических элементов html-верстки используется кастомизированная версия  пакета Bootstrap 4 Minton. Для перезагрузки элементов страницы использется библиотека JQuery.

На стороне сервера для обработки запросов используется среда выполнения Node.js на базе фреймворка Express (в качестве шаблонизатора страниц~-- PUG / Jade). Для хранения данных пользователей и документов применяется noSQL (not only SQL) система управления базами данных (СУБД) MongoDB. Для сопоставления объектов классов и документов коллекций из базы данных используется ODM-библиотека (Object Data Modelling)  Mongoose. Для хранения данных приложения (в основном данные сессий пользователей) используется inMemory СУБД Redis.

Node или Node.js -- программная платформа, основанная на движке V8 (транслирующем JavaScript в машинный код), превращающая JavaScript из узкоспециализированного языка в язык общего назначения. Node.js добавляет возможность JavaScript взаимодействовать с  устройствами ввода-вывода через свой API, подключать другие внешние библиотеки, написанные на разных языках, обеспечивая вызовы к ним из JavaScript-кода. В основе Node.js лежит событийно-ориентированное и асинхронное (или реактивное) программирование с неблокирующим вводом/выводом. В состав Node.js входит собственный установщик пакетов npm. 

Redis (от англ. remote dictionary server) -- резидентная система управления базами данных класса NoSQL с открытым исходным кодом, работающая со структурами данных типа <<ключ-значение>>. Используется как для баз данных, так и для реализации кэшей и брокеров сообщений. Ориентирована на достижение максимальной производительности на атомарных операциях. Хранит базу данных в оперативной памяти, снабжена механизмами снимков и журналирования для обеспечения постоянного хранения (на дисках, твердотельных накопителях). Работает на большинстве POSIX-систем, таких как Linux, *BSD, Mac OS X без каких-либо дополнений. Все данные Redis хранит в виде словаря, в котором ключи связаны со своими значениями.

MongoDB (от англ. humongous — огромный) -- документоориентированная СУБД с открытым исходным кодом, не требующая описания схемы таблиц. Классифицирована как NoSQL, использует JSON-подобные (JavaScript Object Notation) документы и схему базы данных. Запросы могут возвращать конкретные поля документов и пользовательские JavaScript-функции. Поддерживается поиск по регулярным выражениям. Также можно настроить запрос на возвращение случайного набора результатов. MongoDB может работать с набором реплик. Набор реплик состоит из двух и более копий данных. Каждый экземпляр набора реплик может в любой момент выступать в роли основной или вспомогательной реплики. MongoDB масштабируется горизонтально, используя шардинг. MongoDB может быть использован в качестве файлового хранилища с балансировкой нагрузки и репликацией данных.

Mongoose это ODM-библиотека для работы с Mon\-goDB, которая позволяет сопоставлять объекты классов и документы коллекций из базы данных.

\subsection{Установка необходимых пакетов}

Разрабатывать и отлаживать Node.js-приложения рекомендуется в среде операционных систем (ОС) Linux. Возможна разработка из-под Windows-систем, однако в нашем случае СУБД Redis в ОС Windows не поддерживается. Таким образом для разработки приложений рекомендуется использовать Ubuntu, так как в репозиториях этой ОС присутствуют актуальные версии необходимых пакетов программного обеспечения (ПО). Для выполнения в <<боевом>> режиме (далее по тексту -- production) рекомендуется использовать среду ОС Debian, ввиду её высокой стабильности.

Далее будем рассматривать подготовку среды выполнения Node.js в ОС Debian версии 9.6.0 в <<базовой>> установке без графической оболочки. Вкачестве ограничений будет учитываться отсутствие непосредственного подключения к глобальной информационной сети (ГИС) <<Интернет>>. Кроме этого, подразумевается наличие 3 DVD-дисков со стандартными репозиториями, доступных для скачивания с официального сайта Debian.


\textbf{ВНИМАНИЕ!} Подразумевается, что администратор системы имеет опыт работы в Linux-системах и ему понятны основы работы в текстовой консоли.

\begin{enumerate}

\item Войдите в систему в качестве root-пользователя.

\item В целях безопасности в режиме production рекомендуется выполнение Node.js-приложений от имени НЕ-root пользователя, без повышенных привилегий. Создайте пользователя \textit{user} с домашним каталогом.
	
	\verb|useradd user -m|

\item Если диски с репозиториями доступны в виде iso-образов, то скопируйте их в домашний каталог пользователя \textit{root}.

\item\label{mount_disk_2} Смонтируйте диск 2:

	\verb|mount Debian_2.iso /media/cdrom -t iso9660 -o loop|

\item\label{add_disk_2} Добавьте информацию о пакетах со второго диска в систему:
	
	\verb|apt-cdrom add|
	
\item Выполните п.\ref{mount_disk_2} и п.\ref{add_disk_2} для третьего диска. Первый диск добавляется по умолчанию при установке ОС.

\item В стандартных репозиториях Debian присутствует пакет \textit{nodejs}, тем не менее версия пакета в стандартном репозитории 4.6.1, а необходимый для  дальнейшей работы пакет \textit{npm} досупен только в репозитории \textit{oldstable}. Поэтому, рекомендуется скачать последнюю версию пакета \textit{nodejs} с официального сайта www.nodesource.com (на момент написания данного руководства были доступны версии 10.6.х), к тому же, начиная с версии 8.0 пакет \textit{nodejs} содержит в своём составе пакет \textit{npm} и его дополнительная установка не требуется.

\item Скопируйте скачанный пакет \textit{nodejs} в домашний каталог \textit{root}-пользователя и выполните:
	
	\verb|dpkg -i nodejs*|

\item В случае, если установка завершится с неразрешёнными зависимостями, выполните команду:
	
	\verb|apt-get install -f|

\item Проверьте установку пакетов \textit{nodejs} и \textit{npm}:
	
	\begin{verbatim}
		node -v
		npm -v
	\end{verbatim}
в консоли должны отобразиться версии пакетов.

\item В стандартном репозитории присутствуют все необходимые пакеты для установки СУБД MongoDB, поэтому просто выполните команду:
	
	\verb|apt-get install mongodb|

при необходимости разрешения зависимостей смонтируйте необходимые диски.

\item Проверьте установку пакета \textit{mongodb}:
	
	\verb|mongod --version|

в консоли должна отобразиться версия пакета. Обратите внимание, что пакет называется \textit{mongodb}, а <<рабочее>> приложение -- \textit{mongod}.

\item Также, для установки \textit{Redis} выполните:

	\verb|apt-get install redis-server|
	
\item Проверьте установку пакета \textit{Redis}:

	\verb|systemctl status redis|
	
\item Скопируйте папку с приложением АСКИДД в домашний каталог пользователя \textit{user}.

\item Перейдите в каталог с приложением:
	
	\verb|cd /home/user/askid|
	
\item Запуск приложения возможен двумя способами:
\end{enumerate}
	\begin{itemize}
		\item Запуск корневого приложения \verb|/home/user/askid/bin/www| непосредст\-венно в среде выполнения Node.js:
		
			\verb|node bin/www|
			
		В этом случае приложение запускается в режиме отладки и работает на порту 3000.
		
		После запуска этим способом в консоли  отобразятся 3 сообщения раскрывающих режим работы приложения, статус подключения к СУБД \textit{MongoDB}, версию драйвера \textit{Mongoose}. После этого запустите браузер, введите в адресной строке:
		
		 \verb|192.168.0.31:3000|, 
		 
		 после этого должна отобразиться стартовая страница.
		
		\item Для запуска приложения на 80 порту в режиме \textit{production} необходимо запустить его с помощью пакетного менеджера \textit{npm}. В этом случае выполните команду в корне приложения:
		
			\verb|npm start|
			
		В результате также должны отобразиться диагностические сообщения, а при указании адреса в строке браузера нет необходимости указывать порт.
		
		Однако, следует отметить, что запуск \textit{Node.js} приложения от имени пользователя root является небезопасным шагом и используется, как правило, а этапе разработки и отладки. Далее будут раскрыты способы повышения безопасности выполнения приложения.
	\end{itemize}

	
\subsection{Настройка приложения для выполнения в режиме production}
Переменная среды \textit{NODE\_ENV} задает среду выполнения приложения (обычно это среда разработки или рабочая среда). Простейший способ улучшить производительность~-- задать в переменной \textit{NODE\_ENV} рабочую среду (значение <<production>>).

Если \textit{NODE\_ENV} имеет значение <<production>>, то в Express:

	\begin{itemize}
		\item сохраняются в кэше шаблоны представления;
		\item сохраняются в кэше файлы CSS, сгенерированные из расширений CSS;
		\item генерируются менее подробные сообщения об ошибках.
	\end{itemize}

Тестирование показывает, что в результате только этих действий производительность увеличивается втрое.

Запуск приложения в режиме <<production>> осуществляется командой:

\verb|NODE_ENV=production node bin/www|.

Кроме этого в файле \textit{package.json} указана строка:

\verb|"start": "NODE_ENV=production node ./bin/www"|

Таким образом при запуске с помощью \verb|npm start| приложение <<по-умолча\-нию>> запускается в режиме <<production>>.

Также известно, что запуск приложений работающий по 80 порту от имени пользователя root является небезопасной практикой. Однако запуск приложений от НЕ-root пользователя на 80 порту без дополнительных настроек не возможен.

Для того чтобы запустить приложение от имени простого пользователя на 80 порту необходимо:

\begin{enumerate}
	
	\item Установить пакет \textit{libcap2-bin}, который присутствует в стандартном репозитории:
	
		\verb|apt-get install libcap2-bin|
		
	\item Определите путь до основного приложения \textit{Node.js}
	
		\verb|which node|
		
	В нашем случае это: \verb|/usr/bin/node|
		
	\item Разрешите биндинг \textit{Node.js},  выполнив команду с аргументом пути полученным на предыдущем шаге:
	
		\verb|setcap cap_net_bind_service=+ep /usr/bin/node|
		
	\item Войдите в систему пользователем \textit{oleg}, перейдите в каталог:
	
	\verb|/home/oleg/askid| 
	
	и запустите АСКИДД командой:
	
		\verb|npm start|
		
	\item В браузере в строке адреса укажите адрес сервера без указания номера порта -- должна отобразиться стартовая страница.
\end{enumerate}		
\subsection{Запуск приложения в среде менеджера процесcов pm2}
	В ходе выполнения приложений \textit{NodeJs} возможно возникновение непредвиденных ошибок (Uncaught Exception), которые останавливают выполнение приложения и, в результате, требуется его перезапуск. Для обеспечения оперативного перезапуска приложения в случае возникновения непредвиденных ошибок, а также в случае физического перезапуска сервера в целом, применяются менеджеры процессов \textit{NodeJs}. Самыми популярными из них являются \textit{StrongLoop} и \textit{pm2}. Первый обладает избыточным функционалом и возможностью более гибкой настройки. Менеджер процессов \textit{pm2} обладает минимально-необходимым функционалом и более прост в настройке. Рассмотрим порядок установки и настройки \textit{pm2} (при острой необходимости запуск приложения возможен и в среде \textit{StrongLoop}).
	
	Для установки pm2 необходим менеджер пакетов npm. Его основной функцией является установка необходимых разработчику пакетов. Установка пакетов возможна как в режиме онлайн (при наличии подключения к ГИС <<Интернет>>), так и оффлайн. Для установки онлайн выполните команду (в режиме \textit{sudo} или от имени пользователя \textit{root}):
	
	\verb|npm -g install pm2|
	
	Для установки оффлайн необходимо предварительно скопировать папку \verb|/home/user/.npm| с компьютера на котором был установлен \textit{pm2} (папка \textit{.npm} содержит временные файлы, необходимые для установки пакетов). После этого выполнить команду (также в режиме \textit{sudo} или от имени пользователя \textit{root}):
	
	\verb|npm -g install pm2 --no-optional --no-shrinkwrap|
	
	После для запуска приложения в среде \textit{pm2} выполните команду (в корне каталога приложения):
	
	\verb|pm2 start bin/www|
	
	В этом случае приложение запуститься в режиме отладки на порту 3000.
	
	Для запуска приложения в режиме \textit{production} на 80-м порту выполните команду (в корне каталога приложения):
	
	\verb|pm2 start 'npm start'|
	
	В этом случае при внезапной остановке приложения оно будет автоматически перезапущено.
	
	Для просмотра статуса выполнения приложений в среде \textit{pm2} используйте команду:
	
	\verb|pm2 list|
	
	Для принудительной остановки/перезапуска приложений выполните команды:
	
	\verb|pm2 stop bin/www| и \verb|pm2 restart bin/www|
	
	Для обеспечения запуска приложения после перезапуска сервера необходимо запустить \textit{pm2} как службу \textit{systemd}. Для этого выполните команду (в режиме \textit{sudo} или от имени пользователя \textit{root}):
	
	\verb|pm2 startup |
	
	Для того чтобы приложение запустилось в случае перезагрузки сервера, запустите приложение  и введите команду:
	
	\verb|pm2 save|
	
	В этом случае список процессов сохраниться и после перезапуска сервера приложение автоматически перезапуститься. 